name: Build xleaxOS ISO

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-iso:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build ISO in Arch container
        run: |
          docker run --rm --privileged \
            -v "${{ github.workspace }}:/work" \
            -w /work \
            archlinux:latest /bin/bash -lc '
              set -euo pipefail

              retry() {
                local attempts=0
                until "$@"; do
                  attempts=$((attempts + 1))
                  if [ "$attempts" -ge 3 ]; then
                    return 1
                  fi
                  sleep 5
                done
              }

              cp /etc/pacman.conf /tmp/bootstrap-nosig.conf
              sed -i "s/^SigLevel.*/SigLevel = Never/" /tmp/bootstrap-nosig.conf
              sed -i "s/^LocalFileSigLevel.*/LocalFileSigLevel = Never/" /tmp/bootstrap-nosig.conf
              retry pacman -Sy --noconfirm --config /tmp/bootstrap-nosig.conf archlinux-keyring
              retry pacman -Syu --noconfirm archlinux-keyring curl gnupg archiso grub
              pacman-key --init
              pacman-key --populate archlinux

              cachyos_index="$(retry curl -fsSL https://mirror.cachyos.org/repo/x86_64/cachyos/)"
              cachyos_keyring_pkg="$(printf "%s" "$cachyos_index" | grep -o "cachyos-keyring-[^\" ]*pkg\\.tar\\.zst" | head -n1)"
              cachyos_mirrorlist_pkg="$(printf "%s" "$cachyos_index" | grep -o "cachyos-mirrorlist-[^\" ]*pkg\\.tar\\.zst" | head -n1)"
              cachyos_v4_mirrorlist_pkg="$(printf "%s" "$cachyos_index" | grep -o "cachyos-v4-mirrorlist-[^\" ]*pkg\\.tar\\.zst" | head -n1)"
              test -n "$cachyos_keyring_pkg"
              test -n "$cachyos_mirrorlist_pkg"
              test -n "$cachyos_v4_mirrorlist_pkg"
              retry pacman -U --noconfirm --config /tmp/bootstrap-nosig.conf \
                "https://mirror.cachyos.org/repo/x86_64/cachyos/${cachyos_keyring_pkg}" \
                "https://mirror.cachyos.org/repo/x86_64/cachyos/${cachyos_mirrorlist_pkg}" \
                "https://mirror.cachyos.org/repo/x86_64/cachyos/${cachyos_v4_mirrorlist_pkg}"
              pacman-key --populate cachyos || true

              retry pacman -U --noconfirm --config /tmp/bootstrap-nosig.conf \
                "https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-keyring.pkg.tar.zst" \
                "https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-mirrorlist.pkg.tar.zst"
              pacman-key --populate chaotic || true
              retry pacman -Sy --noconfirm

              cp -a /usr/share/archiso/configs/baseline /tmp/xleax_profile
              cp -a /work/xleax_profile/. /tmp/xleax_profile/
              rm -f /tmp/xleax_profile/airootfs/etc/mkinitcpio.d/linux.preset || true

              resolve_or_drop_pkg() {
                local pkg="$1"
                shift
                if pacman -Sp --noconfirm "$pkg" >/dev/null 2>&1; then
                  return 0
                fi
                for alt in "$@"; do
                  if pacman -Sp --noconfirm "$alt" >/dev/null 2>&1; then
                    sed -i "s/^${pkg}$/${alt}/" /tmp/xleax_profile/packages.x86_64
                    return 0
                  fi
                done
                sed -i "/^${pkg}$/d" /tmp/xleax_profile/packages.x86_64
              }

              resolve_or_drop_pkg mesa-git mesa-tkg-git
              resolve_or_drop_pkg calamares calamares-git
              resolve_or_drop_pkg qt5-svg qt5-base
              resolve_or_drop_pkg qt5-xmlpatterns qt5-tools
              resolve_or_drop_pkg polkit-gnome lxqt-policykit polkit
              resolve_or_drop_pkg linux-cachyos-bore linux-cachyos linux
              resolve_or_drop_pkg mutter-performance mutter
              resolve_or_drop_pkg nvidia-open-dkms nvidia-dkms nvidia-open
              resolve_or_drop_pkg ananicy-cpp ananicy-cpp-git
              resolve_or_drop_pkg ananicy-cpp-rules ananicy-rules-git ananicy-cpp-rules-git
              resolve_or_drop_pkg scx-scheds scx-scheds-git scx
              resolve_or_drop_pkg steam steam-native-runtime
              resolve_or_drop_pkg steam-native-runtime steam
              resolve_or_drop_pkg gamescope gamescope-git
              resolve_or_drop_pkg mangohud mangohud-git
              resolve_or_drop_pkg lib32-mangohud mangohud
              resolve_or_drop_pkg goverlay goverlay-bin goverlay-git
              resolve_or_drop_pkg gamemode gamemode-git
              resolve_or_drop_pkg flatpak
              resolve_or_drop_pkg paru-bin paru paru-git pamac
              resolve_or_drop_pkg conky conky-lua conky-git
              resolve_or_drop_pkg snapper
              resolve_or_drop_pkg snap-pac snap-pac-git
              resolve_or_drop_pkg grub-btrfs
              resolve_or_drop_pkg btrfs-progs
              resolve_or_drop_pkg gnome-shell-extension-dash-to-panel dash-to-panel gnome-shell-extension-dash-to-panel-git
              resolve_or_drop_pkg gnome-shell-extension-arc-menu gnome-shell-extension-arcmenu gnome-shell-extension-arc-menu-git arcmenu
              resolve_or_drop_pkg gnome-shell-extension-appindicator gnome-shell-extension-appindicator-git
              resolve_or_drop_pkg gnome-shell-extension-user-theme
              resolve_or_drop_pkg adw-gtk3 adw-gtk-theme
              resolve_or_drop_pkg qemu-full qemu-desktop qemu-base qemu
              resolve_or_drop_pkg libvirt
              resolve_or_drop_pkg virt-manager
              resolve_or_drop_pkg ovmf edk2-ovmf
              resolve_or_drop_pkg dnsmasq
              resolve_or_drop_pkg bridge-utils
              resolve_or_drop_pkg linux-firmware
              resolve_or_drop_pkg sof-firmware
              resolve_or_drop_pkg alsa-firmware
              resolve_or_drop_pkg intel-ucode
              resolve_or_drop_pkg amd-ucode
              resolve_or_drop_pkg fwupd
              awk "NF && !seen[\$0]++" /tmp/xleax_profile/packages.x86_64 > /tmp/xleax_profile/packages.x86_64.tmp
              mv /tmp/xleax_profile/packages.x86_64.tmp /tmp/xleax_profile/packages.x86_64

              # Build-time pacman profile for non-v4 GitHub runners.
              printf "%s\n" \
                "[options]" \
                "HoldPkg = pacman glibc" \
                "Architecture = x86_64" \
                "CheckSpace" \
                "ParallelDownloads = 5" \
                "NoExtract = usr/share/man/* usr/share/info/* usr/share/doc/* usr/share/gtk-doc/* usr/share/help/* usr/include/* usr/lib/pkgconfig/* usr/share/locale/* !usr/share/locale/locale.alias !usr/share/locale/en* !usr/share/locale/C" \
                "" \
                "SigLevel = Required DatabaseOptional" \
                "LocalFileSigLevel = Optional" \
                "" \
                "[cachyos]" \
                "Server = https://mirror.cachyos.org/repo/\$arch/\$repo" \
                "" \
                "[core]" \
                "Server = https://geo.mirror.pkgbuild.com/\$repo/os/\$arch" \
                "" \
                "[extra]" \
                "Server = https://geo.mirror.pkgbuild.com/\$repo/os/\$arch" \
                "" \
                "[multilib]" \
                "Server = https://geo.mirror.pkgbuild.com/\$repo/os/\$arch" \
                "" \
                "[chaotic-aur]" \
                "Server = https://cdn-mirror.chaotic.cx/\$repo/\$arch" \
                > /tmp/xleax_profile/pacman.conf

              mkarchiso -v -w /tmp/archiso-work -o /work/out /tmp/xleax_profile
              iso_path="$(find /work/out -maxdepth 1 -type f -name "*.iso" | head -n1)"
              test -n "$iso_path"
              cp "$iso_path" /work/out/xleaxOS_Ultimate_RC.iso
              sha256sum /work/out/xleaxOS_Ultimate_RC.iso > /work/out/xleaxOS_Ultimate_RC.iso.sha256
            '

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: xleaxos-ultimate-rc
          path: |
            out/xleaxOS_Ultimate_RC.iso
            out/xleaxOS_Ultimate_RC.iso.sha256
          if-no-files-found: error

      - name: Publish ISO to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: xleaxos-ultimate-rc-${{ github.run_number }}
          name: xleaxOS Ultimate RC ${{ github.run_number }}
          prerelease: true
          generate_release_notes: true
          files: |
            out/xleaxOS_Ultimate_RC.iso
            out/xleaxOS_Ultimate_RC.iso.sha256
