#!/usr/bin/env bash
set -euo pipefail

runtime_dir="${XDG_RUNTIME_DIR:-/run/user/$(id -u)}"
status_file="${runtime_dir}/xleax-ghost.status"

ghost_status="Idle"
if [ -r "$status_file" ]; then
  ghost_status="$(tr -dc 'A-Za-z' < "$status_file")"
  [ -n "$ghost_status" ] || ghost_status="Idle"
fi

cpu_psi="$(awk '/^some / {for (i=1; i<=NF; i++) if ($i ~ /^avg10=/) {split($i,a,"="); print a[2]; exit}}' /proc/pressure/cpu 2>/dev/null || true)"
[ -n "$cpu_psi" ] || cpu_psi="0.00"

frame_latency_ms="$(awk -v psi="$cpu_psi" 'BEGIN {printf "%.2f", psi * 10.0}')"

printf 'CPU Frame Latency: %s ms\n' "$frame_latency_ms"
printf 'BORE Pressure: %s%% psi10\n' "$cpu_psi"
printf 'Ghost-Mode: %s\n' "$ghost_status"